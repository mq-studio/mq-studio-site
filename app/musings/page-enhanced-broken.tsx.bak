/**
 * Enhanced Musings Page with Archive Integration
 *
 * This page combines current musings with the imported WordPress
 * blog archive (2009-2017) to create a unified "living archive".
 */

import { Metadata } from 'next';
import Link from 'next/link';
import { enhancedContentService } from '@/lib/content/enhanced-content-service';
import type { LegacyContent } from '@/lib/content/enhanced-content-service';
import MusingList from '@/components/musings/MusingList';
import SubscriptionForm from '@/components/musings/SubscriptionForm';

export const metadata: Metadata = {
  title: 'Musings | MQ Studio',
  description:
    'A living archive of reflections, thoughts, and musings spanning 15+ years of design thinking and creative practice by Moura Quayle.',
  openGraph: {
    title: 'Musings | MQ Studio',
    description:
      'A living archive of reflections, thoughts, and musings spanning 15+ years of design thinking and creative practice by Moura Quayle.',
    type: 'website',
  },
};

// Legacy Musing Badge Component (inline for now)
const LegacyBadge = ({ year, era }: { year: number; era?: string }) => {
  const getEraColor = () => {
    switch (era) {
      case 'early':
        return 'border-[var(--scholar-blue)]'; // 2009-2011: Academic period
      case 'middle':
        return 'border-[var(--living-pink)]'; // 2012-2014: Personal period
      case 'late':
        return 'border-[var(--moura-teal)]'; // 2016-2017: Book period
      default:
        return 'border-[var(--border)]';
    }
  };

  return (
    <div className={`inline-flex items-center gap-2 px-3 py-1 text-xs font-medium bg-[var(--muted)] border-l-3 ${getEraColor()} rounded-r`}>
      <svg
        className="w-3 h-3 opacity-70"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={1.5}
          d="M21 8v13H3V8M1 3h22v5H1zM10 12h4"
        />
      </svg>
      <span className="italic">From the Archives</span>
      <span className="font-semibold border-l pl-2 border-[var(--border)]">{year}</span>
    </div>
  );
};

// Archive Stats Component
const ArchiveStats = ({ stats }: { stats: any }) => {
  return (
    <div className="bg-white rounded-lg p-6 border border-[var(--border)] mb-8">
      <h3 className="font-montserrat text-sm font-semibold text-[var(--scholar-blue)] mb-4 uppercase tracking-wide">
        Living Archive
      </h3>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div>
          <div className="text-2xl font-bold text-[var(--ink-black)]">{stats.total}</div>
          <div className="text-xs text-[var(--charcoal-wash)]">Total Musings</div>
        </div>
        <div>
          <div className="text-2xl font-bold text-[var(--moura-teal)]">{stats.current}</div>
          <div className="text-xs text-[var(--charcoal-wash)]">Recent</div>
        </div>
        <div>
          <div className="text-2xl font-bold text-[var(--scholar-blue)]">{stats.archive}</div>
          <div className="text-xs text-[var(--charcoal-wash)]">Archive (2009-2017)</div>
        </div>
        <div>
          <div className="text-2xl font-bold text-[var(--living-pink)]">
            {Object.keys(stats.byYear).length}
          </div>
          <div className="text-xs text-[var(--charcoal-wash)]">Years Documented</div>
        </div>
      </div>
    </div>
  );
};

// Enhanced Musing Card Component
const EnhancedMusingCard = ({ musing }: { musing: LegacyContent }) => {
  const date = new Date(musing.date);
  const year = date.getFullYear();

  return (
    <article className="bg-white rounded-lg p-6 border border-[var(--border)] hover:shadow-lg transition-shadow">
      {/* Legacy Badge */}
      {musing.legacy && (
        <div className="mb-4">
          <LegacyBadge year={year} era={musing.era} />
        </div>
      )}

      {/* Title */}
      <h2 className="font-montserrat text-xl font-bold text-[var(--ink-black)] mb-2">
        <Link
          href={`/musings/${musing.slug}`}
          className="hover:text-[var(--moura-teal)] transition-colors"
        >
          {musing.title}
        </Link>
      </h2>

      {/* Metadata */}
      <div className="flex items-center gap-4 text-sm text-[var(--charcoal-wash)] mb-4">
        <time dateTime={musing.date}>
          {date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        {musing.metadata?.category && (
          <>
            <span>•</span>
            <span>{musing.metadata.category}</span>
          </>
        )}
        {musing.metadata?.audioUrl && (
          <>
            <span>•</span>
            <span className="flex items-center gap-1">
              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z" />
              </svg>
              Audio
            </span>
          </>
        )}
      </div>

      {/* Description/Excerpt */}
      <p className="font-lora text-[var(--charcoal-wash)] leading-relaxed line-clamp-3">
        {musing.description}
      </p>

      {/* Read More Link */}
      <Link
        href={`/musings/${musing.slug}`}
        className="inline-flex items-center mt-4 text-sm font-medium text-[var(--moura-teal)] hover:text-[var(--scholar-blue)] transition-colors"
      >
        Read more
        <svg className="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
        </svg>
      </Link>
    </article>
  );
};

export default async function EnhancedMusingsPage() {
  // Get all musings including archive
  const allMusings = await enhancedContentService.getMusings(true);

  // Sort by date (newest first, handling legacy dates)
  const sortedMusings = allMusings.sort((a, b) => {
    const dateA = new Date(a.date || '1900-01-01');
    const dateB = new Date(b.date || '1900-01-01');
    return dateB.getTime() - dateA.getTime();
  });

  // Get statistics
  const stats = enhancedContentService.getMusingStats();

  // Separate current and archive for optional filtering
  const currentMusings = sortedMusings.filter(m => !m.legacy);
  const archiveMusings = sortedMusings.filter(m => m.legacy);

  return (
    <div className="min-h-screen bg-[var(--rice-paper)]">
      {/* Header/Navigation */}
      <header className="border-b border-[var(--border)] bg-white">
        <div className="max-w-7xl mx-auto px-6 py-4">
          <Link
            href="/"
            className="inline-flex items-center text-sm font-montserrat text-[var(--scholar-blue)] hover:text-[var(--moura-teal)] transition-colors"
          >
            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
            Back to Studio
          </Link>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-12">
        {/* Page Header */}
        <div className="mb-12">
          <h1 className="font-montserrat text-4xl md:text-5xl font-bold text-[var(--ink-black)] mb-4">
            Musings
          </h1>
          <p className="font-lora text-lg text-[var(--charcoal-wash)] max-w-3xl leading-relaxed">
            A living archive spanning {Object.keys(stats.byYear).length} years of reflections,
            observations, and evolving thoughts on design, governance, and creative practice.
            From academic discourse (2009-2011) through personal explorations (2012-2014)
            to the Designed Leadership journey (2016-2017) and beyond.
          </p>
        </div>

        {/* Archive Statistics */}
        <ArchiveStats stats={stats} />

        {/* Subscription Form */}
        <div className="mb-12">
          <SubscriptionForm />
        </div>

        {/* Filter Tabs (optional - can be added later) */}
        <div className="mb-8 border-b border-[var(--border)]">
          <nav className="flex space-x-8">
            <button className="pb-4 font-medium border-b-2 border-[var(--moura-teal)] text-[var(--moura-teal)]">
              All ({stats.total})
            </button>
            <button className="pb-4 text-[var(--charcoal-wash)] hover:text-[var(--ink-black)] transition-colors">
              Recent ({stats.current})
            </button>
            <button className="pb-4 text-[var(--charcoal-wash)] hover:text-[var(--ink-black)] transition-colors">
              Archive ({stats.archive})
            </button>
            {stats.eras.early > 0 && (
              <button className="pb-4 text-[var(--charcoal-wash)] hover:text-[var(--ink-black)] transition-colors">
                Academic Era ({stats.eras.early})
              </button>
            )}
          </nav>
        </div>

        {/* Musings Grid */}
        <div className="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {sortedMusings.map((musing) => (
            <EnhancedMusingCard key={musing.id} musing={musing} />
          ))}
        </div>

        {/* Empty State (if no musings) */}
        {sortedMusings.length === 0 && (
          <div className="text-center py-16">
            <p className="text-[var(--charcoal-wash)]">No musings found.</p>
          </div>
        )}
      </main>
    </div>
  );
}