name: MCP Server Build & Compliance

on:
  push:
    paths:
      - 'mcp-servers/**'
      - 'infra/mcp-servers/**'
  pull_request:
    paths:
      - 'mcp-servers/**'
      - 'infra/mcp-servers/**'

env:
  REGISTRY: localhost:5000
  REGISTRY_USER: admin
  REGISTRY_PASSWORD: mcpregistry

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.changes.outputs.servers }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed MCP servers
        id: changes
        run: |
          # Find all changed server directories
          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep -E '^(mcp-servers|infra/mcp-servers)/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "servers=$CHANGED_DIRS" >> $GITHUB_OUTPUT
          echo "Changed servers: $CHANGED_DIRS"

  compliance-check:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.servers != '[]'
    strategy:
      matrix:
        server: ${{ fromJson(needs.detect-changes.outputs.servers) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install OPA
        run: |
          curl -L -o opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Validate server directory structure
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          
          if [ ! -d "$SERVER_PATH" ]; then
            echo "âŒ Server directory not found: $SERVER_PATH"
            exit 1
          fi
          
          # Check required files
          REQUIRED_FILES=("Dockerfile" "package.json" "index.js")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$SERVER_PATH/$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          
          echo "âœ… Server directory structure valid"
      
      - name: Dockerfile security validation
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          DOCKERFILE="$SERVER_PATH/Dockerfile"
          
          echo "ğŸ” Checking Dockerfile security..."
          
          # Check for non-root user
          if ! grep -q "USER.*[^0]" "$DOCKERFILE"; then
            echo "âŒ Dockerfile must specify non-root USER"
            exit 1
          fi
          
          # Check for health check
          if ! grep -q "HEALTHCHECK" "$DOCKERFILE"; then
            echo "âŒ Dockerfile missing HEALTHCHECK instruction"
            exit 1
          fi
          
          # Check against using latest tag
          if grep -q "FROM.*:latest" "$DOCKERFILE"; then
            echo "âŒ Dockerfile should not use 'latest' tag"
            exit 1
          fi
          
          echo "âœ… Dockerfile security checks passed"
      
      - name: Package.json validation
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          PACKAGE_JSON="$SERVER_PATH/package.json"
          
          echo "ğŸ” Validating package.json..."
          
          # Check for required MCP SDK
          if ! jq -e '.dependencies["@modelcontextprotocol/sdk"]' "$PACKAGE_JSON" > /dev/null; then
            echo "âŒ Missing required MCP SDK dependency"
            exit 1
          fi
          
          # Check for test script
          if ! jq -e '.scripts.test' "$PACKAGE_JSON" > /dev/null; then
            echo "âŒ Missing test script in package.json"
            exit 1
          fi
          
          # Check for security audit script
          if ! jq -e '.scripts["security:scan"]' "$PACKAGE_JSON" > /dev/null; then
            echo "âŒ Missing security:scan script in package.json"
            exit 1
          fi
          
          echo "âœ… Package.json validation passed"
      
      - name: Install dependencies and run tests
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          cd "$SERVER_PATH"
          
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          
          echo "ğŸ§ª Running tests..."
          npm test
          
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level=moderate
      
      - name: Test coverage validation
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          cd "$SERVER_PATH"
          
          echo "ğŸ“Š Checking test coverage..."
          npm run test:coverage
          
          # Check if coverage meets minimum threshold (80%)
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
            if (( $(echo "$COVERAGE < 80" | bc -l) )); then
              echo "âŒ Test coverage ($COVERAGE%) below minimum (80%)"
              exit 1
            fi
            echo "âœ… Test coverage: $COVERAGE%"
          fi
      
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: ./infra/mcp-servers/${{ matrix.server }}
          format: spdx-json
          output-file: sbom-${{ matrix.server }}.spdx.json
      
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.server }}
          path: sbom-${{ matrix.server }}.spdx.json

  build-and-scan:
    runs-on: ubuntu-latest
    needs: [detect-changes, compliance-check]
    if: needs.detect-changes.outputs.servers != '[]'
    strategy:
      matrix:
        server: ${{ fromJson(needs.detect-changes.outputs.servers) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to registry
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin
      
      - name: Build Docker image
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          IMAGE_TAG="${{ env.REGISTRY }}/idp/${{ matrix.server }}:${{ github.sha }}"
          
          echo "ğŸ—ï¸ Building image: $IMAGE_TAG"
          docker build -t "$IMAGE_TAG" "$SERVER_PATH"
          
          # Also tag as latest for development
          docker tag "$IMAGE_TAG" "${{ env.REGISTRY }}/idp/${{ matrix.server }}:latest"
      
      - name: Security scan with Trivy
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/idp/${{ matrix.server }}:${{ github.sha }}"
          
          echo "ğŸ›¡ï¸ Scanning image for vulnerabilities..."
          trivy image \
            --severity HIGH,CRITICAL \
            --format json \
            --output trivy-report-${{ matrix.server }}.json \
            "$IMAGE_TAG"
          
          # Check if any HIGH or CRITICAL vulnerabilities found
          CRITICAL_COUNT=$(jq '[.Results[]? | select(.Vulnerabilities) | .Vulnerabilities[] | select(.Severity=="CRITICAL")] | length' trivy-report-${{ matrix.server }}.json)
          HIGH_COUNT=$(jq '[.Results[]? | select(.Vulnerabilities) | .Vulnerabilities[] | select(.Severity=="HIGH")] | length' trivy-report-${{ matrix.server }}.json)
          
          echo "Found vulnerabilities: $CRITICAL_COUNT critical, $HIGH_COUNT high"
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found - blocking deployment"
            exit 1
          fi
          
          if [ "$HIGH_COUNT" -gt 5 ]; then
            echo "âŒ Too many high-severity vulnerabilities ($HIGH_COUNT > 5)"
            exit 1
          fi
          
          echo "âœ… Security scan passed"
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ matrix.server }}
          path: trivy-report-${{ matrix.server }}.json
      
      - name: Push to registry
        if: github.ref == 'refs/heads/main'
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/idp/${{ matrix.server }}:${{ github.sha }}"
          LATEST_TAG="${{ env.REGISTRY }}/idp/${{ matrix.server }}:latest"
          
          echo "ğŸ“¤ Pushing images to registry..."
          docker push "$IMAGE_TAG"
          docker push "$LATEST_TAG"
          
          echo "âœ… Images pushed successfully"

  policy-validation:
    runs-on: ubuntu-latest
    needs: [detect-changes, compliance-check]
    if: needs.detect-changes.outputs.servers != '[]'
    strategy:
      matrix:
        server: ${{ fromJson(needs.detect-changes.outputs.servers) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install OPA
        run: |
          curl -L -o opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/
      
      - name: Validate docker-compose configuration
        run: |
          SERVER_PATH="infra/mcp-servers/${{ matrix.server }}"
          COMPOSE_FILE="$SERVER_PATH/docker-compose.yml"
          
          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "âŒ Missing docker-compose.yml for ${{ matrix.server }}"
            exit 1
          fi
          
          echo "ğŸ” Validating docker-compose against policies..."
          
          # Convert YAML to JSON for OPA
          docker run --rm -v $(pwd):/workdir mikefarah/yq:latest \
            eval -o=json "$COMPOSE_FILE" > compose-${{ matrix.server }}.json
          
          # Add metadata for policy validation
          jq '. + {"kind": "service", "environment": "production"}' \
            compose-${{ matrix.server }}.json > policy-input-${{ matrix.server }}.json
          
          # Run OPA policy check
          opa eval \
            --data governance/policies/mcp-server-policy.rego \
            --input policy-input-${{ matrix.server }}.json \
            --format pretty \
            'data.mcp.server.compliance.deny[x]' > policy-violations.txt
          
          # Check for policy violations
          if [ -s policy-violations.txt ]; then
            echo "âŒ Policy violations found:"
            cat policy-violations.txt
            exit 1
          fi
          
          echo "âœ… Policy validation passed"

  deployment-readiness:
    runs-on: ubuntu-latest
    needs: [build-and-scan, policy-validation]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Deployment summary
        run: |
          echo "ğŸ‰ All MCP servers passed compliance checks!"
          echo "âœ… Security scans completed"
          echo "âœ… Policy validation passed"
          echo "âœ… Images built and pushed to registry"
          echo ""
          echo "Servers ready for deployment:"
          echo "${{ needs.detect-changes.outputs.servers }}" | jq -r '.[]' | sed 's/^/  - /'