# Docker Compose template for MCP servers
# Replace {{SERVER_NAME}} with actual server name

services:
  {{SERVER_NAME}}:
    image: localhost:5000/idp/{{SERVER_NAME}}:latest
    container_name: {{SERVER_NAME}}
    
    # Governance-compliant environment variables
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - GOVERNANCE_LOG=/logs/{{SERVER_NAME}}.log
      - MCP_SERVER_NAME={{SERVER_NAME}}
      # Add server-specific environment variables here
    
    # Resource limits (required by governance policy)
    deploy:
      resources:
        limits:
          memory: 128Mi
          cpu: 100m
        reservations:
          memory: 64Mi
          cpu: 50m
    
    # Health check (required by governance policy)
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('healthy')"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    
    # Network configuration
    networks:
      - mcp-internal  # Default to internal network
      # - mcp-public  # Uncomment if external access needed
    
    # Volume mounts
    volumes:
      - ./logs:/logs
      # Add server-specific volumes here
    
    # Security configuration
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (uncomment if server supports it)
    # read_only: true
    # tmpfs:
    #   - /tmp
    #   - /var/tmp
    
    # Restart policy
    restart: unless-stopped
    
    # Governance labels (required by policy)
    labels:
      - "mcp.server={{SERVER_NAME}}"
      - "mcp.governance.level=medium"  # low/medium/high
      - "mcp.governance.audit=true"
      - "mcp.compliance.version=1.0"
      - "mcp.owner=infrastructure-team"
      - "mcp.created-date=$(date -I)"
    
    # Dependencies (if any)
    depends_on:
      mcp-hub:
        condition: service_healthy

  # Include MCP Hub if this is a standalone deployment
  mcp-hub:
    image: localhost:5000/idp/mcp-hub:latest
    container_name: mcp-hub
    ports:
      - "3010:3010"  # MCP protocol
      - "3011:3011"  # A2A protocol
    environment:
      - MCP_MODE=centralized
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - mcp-internal
      - mcp-public
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

networks:
  mcp-internal:
    name: mcp-internal
    driver: bridge
    internal: true
  
  mcp-public:
    name: mcp-public
    driver: bridge

volumes:
  {{SERVER_NAME}}-data:
    driver: local